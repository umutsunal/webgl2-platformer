<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
    <title>BBM412 Project</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <canvas id="canvas" width="800" height="800"></canvas>
        <script src="js/three.js"></script>
        <script src="js/cannon.js"></script>
        <script src="js/GLTFLoader.js"></script>
        <script src='js/THREEx.FullScreen.js'></script>
        
        
<script>
    (function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.body.appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='//mrdoob.github.io/stats.js/build/stats.min.js';document.head.appendChild(script);})()
    
    
    //Disco Ball Shaders
    {
    var discoBallFragmentShader = `#version 300 es
        precision highp float;
        precision highp int;

        #include <common>
        
        
        uniform vec3 iResolution;
        uniform float iTime;
        uniform sampler2D iChannel0;

        #define TIMESCALE 0.25 
        #define TILES 8
        #define COLOR 0.7, 1.6, 2.8
        
        out vec4 outColor;

        void mainImage( out vec4 outColor, in vec2 fragCoord )
        {
            vec2 uv = fragCoord.xy / iResolution.xy;
            uv.x *= iResolution.x / iResolution.y;
    
            vec4 noise = texture(iChannel0, floor(uv * float(TILES)) / float(TILES));
            float p = 1.0 - mod(noise.r + noise.g + noise.b + iTime * float(TIMESCALE), 1.0);
            p = min(max(p * 3.0 - 1.8, 0.1), 2.0);
    
            vec2 r = mod(uv * float(TILES), 1.0);
            r = vec2(pow(r.x - 0.5, 2.0), pow(r.y - 0.5, 2.0));
            p *= 1.0 - pow(min(1.0, 12.0 * dot(r, r)), 2.0);
    
            outColor = vec4(COLOR, 1.0) * p;
        }

        in vec2 vUv;

        void main() {
            mainImage(outColor, vUv * iResolution.xy);
        }
    `;
    var discoBallVertexShader = `#version 300 es
        out vec2 vUv;
        void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
    `;    
}

    
    var sphereShape, sphereBody, groundBody, world, physicsMaterial, walls=[], balls=[], ballMeshes=[], boxes=[], boxMeshes=[];
    var canJump = false;
    var velocity = new THREE.Vector3(), jumpVelocity = 160;   
    
   
    var time;
    const clock = new THREE.Clock();
    var scene, camera, canvas, renderer, context;
    
    var movableModels = [];
    var flat_models = [];
    var smooth_models = [];
    
    var movingPlatforms = [];
    var movingPlatformDirection;
    var movingPlatformDirection2 = 0;
    
    var normalLeverFlat, normalLeverSmooth;
    var usedLeverFlat, usedLeverSmooth;
    var normalLeverFlat2, normalLeverSmooth2;
    var usedLeverFlat2, usedLeverSmooth2;
    var isLever1Used = false;
    var isLever2Used = false;
    
    var is1Falling = false;
    var is2Falling = false;
    var is3Falling = false;
    var is4Falling = false;
    var is5Falling = false;
    var is6Falling = false;
    var is7Falling = false;
    var is8Falling = false;
    var is9Falling = false;
    
    var chest_flat;
    var chest_smooth;
    var isChestTaken = false;
    
    var removeBodies = false;
    var platformBoxBody3, platformBoxBody4;
    
    
    var isLampOpened = true;
    var ambientLight;
    
    var pickedobject = null;
    var pickedgroup;
    var isAnyObjectSelected = false;
    var isSelectedBefore = false;
    var isRotationXChanged = false;
    var areLightsCreated = false;

    var keyboard = {};
    var player = {
        
        height:20, 
        speed:1.6,
        runningSpeed:2.0,
        turnSpeed: Math.PI * 0.01, 
    };

    var pickPosition = {x: 0, y: 0};
    
    var checkpointStatus = 0;
    var checkpoint_x, checkpoint_y, checkpoint_z;
    
    
function initCannon(){
    // Setup our world
    world = new CANNON.World();
    world.quatNormalizeSkip = 0;
    world.quatNormalizeFast = false;

    var solver = new CANNON.GSSolver();

    world.defaultContactMaterial.contactEquationStiffness = 1e9;
    world.defaultContactMaterial.contactEquationRelaxation = 4;
    
    solver.iterations = 7;
    solver.tolerance = 0.1;
    var split = true;
    
    if(split)
        world.solver = new CANNON.SplitSolver(solver);
    else
        world.solver = solver;

    world.gravity.set(0,-400,0);
    world.broadphase = new CANNON.NaiveBroadphase();

    // Create a slippery material (friction coefficient = 0.0)
    physicsMaterial = new CANNON.Material("slipperyMaterial");
    var physicsContactMaterial = new CANNON.ContactMaterial(physicsMaterial,
                                                            physicsMaterial,
                                                            0.0, // friction coefficient
                                                            0.3  // restitution
                                                            );
    // We must add the contact materials to the world
    world.addContactMaterial(physicsContactMaterial);

    // Create a sphere
    var mass = 20, radius = 20;
    sphereShape = new CANNON.Sphere(radius);
    sphereBody = new CANNON.Body({ mass: mass });
    sphereBody.addShape(sphereShape);
    sphereBody.position.set(5,player.height,-100);
    sphereBody.linearDamping = 0.9;
    world.add(sphereBody);

    // Create a plane
    var groundShape = new CANNON.Plane();
    var groundBody = new CANNON.Body({ mass: 0 });
    groundBody.addShape(groundShape);
    groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),-Math.PI/2);
    world.add(groundBody);
}   //initialize the cannon.js world


    
function main() {

    scene = new THREE.Scene();
    
    //canvas = document.querySelector('#canvas');
    canvas = document.getElementById('canvas');
    
    context = canvas.getContext('webgl2', { alpha: false } );
    renderer = new THREE.WebGLRenderer( { canvas: canvas, context: context } );    
    
    
    
    renderer.setClearColor("#889FFB");
    renderer.setSize(window.innerWidth, window.innerHeight);  
    renderer.outputEncoding = THREE.sRGBEncoding;

    var isLocked = false;
    var isFlat = true;
    //var time;
    const RADIUS = 20;
    
    var scale = 1;
    var rotSpd = 0.05;
    var spd = 0.1;
    var input = {left:0,right:0, up: 0, down: 0};
    
    var textureLoader = new THREE.TextureLoader();
    
    
    //Camera
    {
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100000);

        // position and point the camera to the center of the scene
        
        //camera.position.set(sphereBody.position);    
            
        camera.position.x = 5;
        camera.position.y = player.height;
        camera.position.z = -100;
        camera.lookAt(new THREE.Vector3(0, player.height, 0));

        camera.eulerOrder = "YXZ"; 
    }
    
    //Disco Cube
    {
        var discoCubeGeometry = new THREE.BoxGeometry(2, 2, 2);
        var discoCubeTexture = textureLoader.load('https://threejsfundamentals.org/threejs/resources/images/bayer.png');
        discoCubeTexture.minFilter = THREE.NearestFilter;
        discoCubeTexture.magFilter = THREE.NearestFilter;
        discoCubeTexture.wrapS = THREE.RepeatWrapping;
        discoCubeTexture.wrapT = THREE.RepeatWrapping;
    
        var discoCubeUniforms = {
            iTime: { value: 0 },
            iResolution:  { value: new THREE.Vector3(1, 1, 1) },
            iChannel0: { value: discoCubeTexture },
        };

        var discoCubeMaterial = new THREE.ShaderMaterial({
            vertexShader: discoBallVertexShader,
            fragmentShader: discoBallFragmentShader,
            uniforms: discoCubeUniforms,
        });
            
        //var discoCubeMaterial = new THREE.MeshPhongMaterial();
        

        var discoCube = new THREE.Mesh(discoCubeGeometry, discoCubeMaterial);
        discoCube.position.set(-87, 19.5, -55);
        scene.add(discoCube);
        movableModels.push(discoCube);
    }
    
    //Room
    {
        var roomGeometry = new THREE.BoxGeometry(200, 60, 250);
        var roomMaterials = [
        new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load("textures/grey_brick_wall.jpg"), side: THREE.DoubleSide } ),
        new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load("textures/grey_brick_wall.jpg"), side: THREE.DoubleSide } ),
        new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load("textures/grey_brick_wall.jpg"), side: THREE.DoubleSide } ),
        new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load("textures/wooden_floor.jpg"), side: THREE.DoubleSide } ), //Floor
        new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load("textures/grey_brick_wall.jpg"), side: THREE.DoubleSide } ),
        new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load("textures/grey_brick_wall.jpg"), side: THREE.DoubleSide } ),
        ];
            
        var room = new THREE.Mesh(roomGeometry, roomMaterials);
        room.position.y = 30;
      
        scene.add(room);   
    }

    //Movable Items
    {
    
    
    var torusGeometry = new THREE.TorusKnotGeometry( 10, 3, 100, 16 );
    var torusMaterial = new THREE.MeshPhongMaterial( { color: 0xEDDA41 } );
    var torusKnot = new THREE.Mesh( torusGeometry, torusMaterial );
    torusKnot.position.set(-95, 20, -75);
    torusKnot.scale.set(0.1, 0.1, 0.1);
    scene.add( torusKnot );
    movableModels.push(torusKnot);
    
            
    function CustomSinCurve( scale ) {
    
	THREE.Curve.call( this );

	this.scale = ( scale === undefined ) ? 1 : scale;

    }

    CustomSinCurve.prototype = Object.create( THREE.Curve.prototype );
    CustomSinCurve.prototype.constructor = CustomSinCurve;

    CustomSinCurve.prototype.getPoint = function ( t ) {

	var tx = t * 3 - 1.5;
	var ty = Math.sin( 2 * Math.PI * t );
	var tz = 0;

	return new THREE.Vector3( tx, ty, tz ).multiplyScalar( this.scale );

    };

    var path = new CustomSinCurve( 10 );
    var geometry = new THREE.TubeGeometry( path, 64, 1, 8, false );
    var material = new THREE.MeshPhongMaterial( { color: 0x7991C5 } );
    var mesh = new THREE.Mesh( geometry, material );
    mesh.rotation.y = Math.PI / 2;
    mesh.rotation.x = Math.PI / 2;
    mesh.rotation.z = Math.PI / 2;
    mesh.position.set(-95, 20, -85);
    mesh.scale.set(0.20, 0.20, 0.20);
    scene.add( mesh );
    movableModels.push(mesh);


    
    }

    //Lights
    {    
       
        var lampLight = new THREE.PointLight(0xFFFFFF, 0.0, 300);
        lampLight.position.set(20, 30, 95);
        scene.add(lampLight);

        var lampLight2 = new THREE.PointLight(0xFFFFFF, 0.0, 300);
        lampLight2.position.set(20, 30, 115);
        scene.add(lampLight2);
        
        var lampLight3 = new THREE.PointLight(0xFFFFFF, 0.0, 300);
        lampLight3.position.set(40, 30, -120);
        scene.add(lampLight3);

        var lampLight4 = new THREE.PointLight(0xFFFFFF, 0.0, 300);
        lampLight4.position.set(40, 30, -110);
        scene.add(lampLight4);        
        
        
        
        
        var discoCubeLight = new THREE.PointLight(0x1646FF, 1.0, 150);
        discoCubeLight.position.set(discoCube.position.x, discoCube.position.y, discoCube.position.z);
        
        scene.add(discoCubeLight);
  
    }
    
    //Floor
    {
        floorgeometry = new THREE.PlaneGeometry( 3500, 3500, 50, 50 );
        floorgeometry.applyMatrix( new THREE.Matrix4().makeRotationX( - Math.PI / 2 ) );

        var grassTexture = textureLoader.load("textures/grass2.jpg");
        grassTexture.minFilter = THREE.NearestFilter;
        grassTexture.magFilter = THREE.NearestFilter;
        grassTexture.wrapS = THREE.RepeatWrapping;
        grassTexture.wrapT = THREE.RepeatWrapping;
        grassTexture.repeat.set( 80, 80 );

        material = new THREE.MeshLambertMaterial( { map: grassTexture, side: THREE.FrontSide } );

        floormesh = new THREE.Mesh( floorgeometry, material );
        //floormesh.castShadow = true;
        //floormesh.receiveShadow = true;
        //floormesh.position.x = 20;
        //floormesh.position.y = -10;
        //floormesh.position.z = 5;
        
        floormesh.position.z = 450;
        floormesh.position.y = -0.1;
        scene.add( floormesh );
    }
    
    //Boxes
    {
        // Add boxes
        var halfExtents = new CANNON.Vec3(10,10,10);
        var boxShape = new CANNON.Box(halfExtents);
        var boxGeometry = new THREE.BoxGeometry(halfExtents.x*2,halfExtents.y*2,halfExtents.z*2);
        var newBoxMaterials = [
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/wooden_crate.png"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/wooden_crate.png"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/wooden_crate.png"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/wooden_crate.png"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/wooden_crate.png"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/wooden_crate.png"), side: THREE.DoubleSide} ),
        ];
        var newBoxMaterial = new THREE.MeshFaceMaterial(newBoxMaterials);     
    
        
        var platformHalfExtents = new CANNON.Vec3(15,5,15);
        var platformShape = new CANNON.Box(platformHalfExtents);
        var platformGeometry = new THREE.BoxGeometry(platformHalfExtents.x*2,platformHalfExtents.y*2,platformHalfExtents.z*2);
        var newPlatformMaterials = [
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
        ];
        var platformMaterial = new THREE.MeshFaceMaterial(newPlatformMaterials); 
        
        
        var platformHalfExtents2 = new CANNON.Vec3(50,10,50);
        var platformShape2 = new CANNON.Box(platformHalfExtents2);
        var platformGeometry2 = new THREE.BoxGeometry(platformHalfExtents2.x*2,platformHalfExtents2.y*2,platformHalfExtents2.z*2);
        var newPlatformMaterials2 = [
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
        ];
        var platformMaterial2 = new THREE.MeshFaceMaterial(newPlatformMaterials2);         
        
        var platformHalfExtents3 = new CANNON.Vec3(15,2,15);
        var platformShape3 = new CANNON.Box(platformHalfExtents3);
        var platformGeometry3 = new THREE.BoxGeometry(platformHalfExtents3.x*2,platformHalfExtents3.y*2,platformHalfExtents3.z*2);
        var newPlatformMaterials3 = [
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metalgrill.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metalgrill.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metalgrill.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metalgrill.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metalgrill.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metalgrill.jpg"), side: THREE.DoubleSide} ),
        ];
        var platformMaterial3 = new THREE.MeshFaceMaterial(newPlatformMaterials3);    
        
        
        var platformHalfExtents5 = new CANNON.Vec3(50,10,50);
        var platformShape5 = new CANNON.Box(platformHalfExtents5);
        var platformGeometry5 = new THREE.BoxGeometry(platformHalfExtents5.x*2,platformHalfExtents5.y*2,platformHalfExtents5.z*2);
        var newPlatformMaterials5 = [
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
        ];
        var platformMaterial5 = new THREE.MeshFaceMaterial(newPlatformMaterials5);         
        
        
        
        
        
        
        
        var movingPlatformHalfExtents = new CANNON.Vec3(30, 5, 15);
        var movingPlatformShape = new CANNON.Box(movingPlatformHalfExtents);
        var movingPlatformGeometry = new THREE.BoxGeometry(movingPlatformHalfExtents.x*2,movingPlatformHalfExtents.y*2,movingPlatformHalfExtents.z*2);
        var movingPlatformMaterials = [
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
        ];
        var movingPlatformMaterial = new THREE.MeshFaceMaterial(movingPlatformMaterials);         
        
        var movingPlatformHalfExtents2 = new CANNON.Vec3(20, 5, 20);
        var movingPlatformShape2 = new CANNON.Box(movingPlatformHalfExtents2);
        var movingPlatformGeometry2 = new THREE.BoxGeometry(movingPlatformHalfExtents2.x*2,movingPlatformHalfExtents2.y*2,movingPlatformHalfExtents2.z*2);
        var movingPlatformMaterials2 = [
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
            new THREE.MeshLambertMaterial( {map: textureLoader.load("textures/metal.jpg"), side: THREE.DoubleSide} ),
        ];
        var movingPlatformMaterial2 = new THREE.MeshFaceMaterial(movingPlatformMaterials2);   
        
        
        
    }
    
    //Jumping
    {
        var contactNormal = new CANNON.Vec3(); // Normal in the contact, pointing *out* of whatever the player touched
        var upAxis = new CANNON.Vec3(0, 1, 0);
        sphereBody.addEventListener("collide", function (e) {
        var contact = e.contact;

        // contact.bi and contact.bj are the colliding bodies, and contact.ni is the collision normal.
        // We do not yet know which one is which! Let's check.

        if (contact.bi.id == sphereBody.id) {
            contact.ni.negate(contactNormal);
        } // bi is the player body, flip the contact normal
        else {
            contactNormal.copy(contact.ni); // bi is something else. Keep the normal as it is
        }

        // If contactNormal.dot(upAxis) is between 0 and 1, we know that the contact normal is somewhat in the up direction.
        if (contactNormal.dot(upAxis) > 0.5) {
            // Use a "good" threshold value between 0 and 1 here!
            canJump = true;
        }
        });        
    }
    
    // Add boxes
    {
        var BoxBody = new CANNON.Body( { mass: 5} )
        BoxBody.addShape(boxShape);
        var BoxMesh = new THREE.Mesh( boxGeometry, newBoxMaterial );
        world.add(BoxBody);
        scene.add(BoxMesh);
        BoxBody.position.set(0,20,600);
        BoxMesh.position.set(0,20,600);
        BoxMesh.castShadow = true;
        BoxMesh.receiveShadow = true;
        boxes.push(BoxBody);
        boxMeshes.push(BoxMesh);


        var platformBoxBody = new CANNON.Body( { mass: 0} );
        platformBoxBody.addShape(platformShape);
        var platformBoxMesh = new THREE.Mesh( platformGeometry, platformMaterial );
        world.add(platformBoxBody);
        scene.add(platformBoxMesh);
        platformBoxBody.position.set(0,40,800);
        platformBoxMesh.position.set(0,40,800);
        platformBoxMesh.castShadow = true;
        platformBoxMesh.receiveShadow = true;
        boxes.push(platformBoxBody);
        boxMeshes.push(platformBoxMesh);
        
        
        var platformBoxBody2 = new CANNON.Body( { mass: 0} );
        platformBoxBody2.addShape(platformShape2);
        var platformBoxMesh2 = new THREE.Mesh( platformGeometry2, platformMaterial2 );
        world.add(platformBoxBody2);
        scene.add(platformBoxMesh2);
        platformBoxBody2.position.set(0, 80, 1050);
        platformBoxMesh2.position.set(0, 80, 1050);
        platformBoxMesh2.castShadow = true;
        platformBoxMesh2.receiveShadow = true;
        boxes.push(platformBoxBody2);
        boxMeshes.push(platformBoxMesh2);        
        
        
        platformBoxBody3 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody3.addShape(platformShape3);
        platformBoxBody3.fixedRotation = true;
        var platformBoxMesh3 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody3);
        scene.add(platformBoxMesh3);
        platformBoxBody3.position.set(0, 200, 1230);
        platformBoxMesh3.position.set(0, 200, 1230);
        platformBoxMesh3.castShadow = true;
        platformBoxMesh3.receiveShadow = true;
        boxes.push(platformBoxBody3);
        boxMeshes.push(platformBoxMesh3);
        
        
        platformBoxBody4 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody4.addShape(platformShape3);
        platformBoxBody4.fixedRotation = true;
        var platformBoxMesh4 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody4);
        scene.add(platformBoxMesh4);
        platformBoxBody4.position.set(0, 200, 1310);
        platformBoxMesh4.position.set(0, 200, 1310);
        platformBoxMesh4.castShadow = true;
        platformBoxMesh4.receiveShadow = true;
        boxes.push(platformBoxBody4);
        boxMeshes.push(platformBoxMesh4);       
        
        
        var platformBoxBody5 = new CANNON.Body( { mass: 0} );
        platformBoxBody5.addShape(platformShape5);
        var platformBoxMesh5 = new THREE.Mesh( platformGeometry5, platformMaterial5 );
        world.add(platformBoxBody5);
        scene.add(platformBoxMesh5);
        platformBoxBody5.position.set(-110, 180, 1420);
        platformBoxMesh5.position.set(-110, 180, 1420);
        platformBoxMesh5.castShadow = true;
        platformBoxMesh5.receiveShadow = true;
        boxes.push(platformBoxBody5);
        boxMeshes.push(platformBoxMesh5);
        
        
        
        var platformBoxBody6 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody6.addShape(platformShape3);
        platformBoxBody6.fixedRotation = true;
        var platformBoxMesh6 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody6);
        scene.add(platformBoxMesh6);
        platformBoxBody6.position.set(-210, 180, 1450);
        platformBoxMesh6.position.set(-210, 180, 1450);
        platformBoxMesh6.castShadow = true;
        platformBoxMesh6.receiveShadow = true;
        boxes.push(platformBoxBody6);
        boxMeshes.push(platformBoxMesh6);
        
        
        var platformBoxBody7 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody7.addShape(platformShape3);
        platformBoxBody7.fixedRotation = true;
        var platformBoxMesh7 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody7);
        scene.add(platformBoxMesh7);
        platformBoxBody7.position.set(-290, 180, 1390);
        platformBoxMesh7.position.set(-290, 180, 1390);
        platformBoxMesh7.castShadow = true;
        platformBoxMesh7.receiveShadow = true;
        boxes.push(platformBoxBody7);
        boxMeshes.push(platformBoxMesh7);          
        
        var platformBoxBody8 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody8.addShape(platformShape3);
        platformBoxBody8.fixedRotation = true;
        var platformBoxMesh8 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody8);
        scene.add(platformBoxMesh8);
        platformBoxBody8.position.set(-370, 180, 1450);
        platformBoxMesh8.position.set(-370, 180, 1450);
        platformBoxMesh8.castShadow = true;
        platformBoxMesh8.receiveShadow = true;
        boxes.push(platformBoxBody8);
        boxMeshes.push(platformBoxMesh8); 
        
        var platformBoxBody9 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody9.addShape(platformShape3);
        platformBoxBody9.fixedRotation = true;
        var platformBoxMesh9 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody9);
        scene.add(platformBoxMesh9);
        platformBoxBody9.position.set(-450, 180, 1390);
        platformBoxMesh9.position.set(-450, 180, 1390);
        platformBoxMesh9.castShadow = true;
        platformBoxMesh9.receiveShadow = true;
        boxes.push(platformBoxBody9);
        boxMeshes.push(platformBoxMesh9); 
        
        
        var platformBoxBody10 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody10.addShape(platformShape3);
        platformBoxBody10.fixedRotation = true;
        var platformBoxMesh10 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody10);
        scene.add(platformBoxMesh10);
        platformBoxBody10.position.set(-530, 180, 1450);
        platformBoxMesh10.position.set(-530, 180, 1450);
        platformBoxMesh10.castShadow = true;
        platformBoxMesh10.receiveShadow = true;
        boxes.push(platformBoxBody10);
        boxMeshes.push(platformBoxMesh10); 
        
        var platformBoxBody11 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody11.addShape(platformShape3);
        platformBoxBody11.fixedRotation = true;
        var platformBoxMesh11 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody11);
        scene.add(platformBoxMesh11);
        platformBoxBody11.position.set(-610, 180, 1390);
        platformBoxMesh11.position.set(-610, 180, 1390);
        platformBoxMesh11.castShadow = true;
        platformBoxMesh11.receiveShadow = true;
        boxes.push(platformBoxBody11);
        boxMeshes.push(platformBoxMesh11); 
        
        var platformBoxBody12 = new CANNON.Body( { mass: 0, type: CANNON.Body.DYNAMIC} );
        platformBoxBody12.addShape(platformShape3);
        platformBoxBody12.fixedRotation = true;
        var platformBoxMesh12 = new THREE.Mesh( platformGeometry3, platformMaterial3 );
        world.add(platformBoxBody12);
        scene.add(platformBoxMesh12);
        platformBoxBody12.position.set(-690, 180, 1420);
        platformBoxMesh12.position.set(-690, 180, 1420);
        platformBoxMesh12.castShadow = true;
        platformBoxMesh12.receiveShadow = true;
        boxes.push(platformBoxBody12);
        boxMeshes.push(platformBoxMesh12); 
        
        

        
        


        var movingPlatformBoxBody = new CANNON.Body( { mass: 0} );
        movingPlatformBoxBody.addShape(movingPlatformShape);
        var movingPlatformBoxMesh = new THREE.Mesh( movingPlatformGeometry, movingPlatformMaterial );
        world.add(movingPlatformBoxBody);
        scene.add(movingPlatformBoxMesh);
        movingPlatformBoxBody.position.set(0.1,60,900);
        movingPlatformBoxMesh.position.set(0.1,60,900);
        movingPlatformBoxMesh.castShadow = true;
        movingPlatformBoxMesh.receiveShadow = true;
        boxes.push(movingPlatformBoxBody);
        boxMeshes.push(movingPlatformBoxMesh);  
    
        
        var movingPlatformBoxBody2 = new CANNON.Body( { mass: 0} );
        movingPlatformBoxBody2.addShape(movingPlatformShape2);
        var movingPlatformBoxMesh2 = new THREE.Mesh( movingPlatformGeometry2, movingPlatformMaterial2 );
        world.add(movingPlatformBoxBody2);
        scene.add(movingPlatformBoxMesh2);
        movingPlatformBoxBody2.position.set(0,90,1150);
        movingPlatformBoxMesh2.position.set(0,90,1150);
        movingPlatformBoxMesh2.castShadow = true;
        movingPlatformBoxMesh2.receiveShadow = true;
        boxes.push(movingPlatformBoxBody2);
        boxMeshes.push(movingPlatformBoxMesh2);          
        
        var movingPlatformBoxBody3 = new CANNON.Body( { mass: 0} );
        movingPlatformBoxBody3.addShape(movingPlatformShape2);
        var movingPlatformBoxMesh3 = new THREE.Mesh( movingPlatformGeometry2, movingPlatformMaterial2 );
        world.add(movingPlatformBoxBody3);
        scene.add(movingPlatformBoxMesh3);
        movingPlatformBoxBody3.position.set(-750, 150, 1420);
        movingPlatformBoxMesh3.position.set(-750, 150, 1420);
        movingPlatformBoxMesh3.castShadow = true;
        movingPlatformBoxMesh3.receiveShadow = true;
        boxes.push(movingPlatformBoxBody3);
        boxMeshes.push(movingPlatformBoxMesh3); 
    }
    

    
    var loader = new THREE.GLTFLoader();
    
    var rock3_flat, rock3_smooth, door_flat, door_smooth, lever_flat, lever_smooth; 
        
    //Load Models
    {
        loader.load( 'models/Rock_Moss_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(200, 2, 190);
            rock3_flat.scale.set(5, 5, 5);
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 200 + j*400;
                    newRock_flat.position.z = 190 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -200 - j*400;
                    newRock_flat.position.z = 190 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/Rock_Moss_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(200, 2, 190);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(5, 5, 5);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 200 + j*400;
                    newRock_smooth.position.z = 190 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -200 - j*400;
                    newRock_smooth.position.z = 190 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });            
        
        loader.load( 'models/Rock3_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(270, 2, 250);
            rock3_flat.scale.set(10, 10, 10);
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 270 + j*400;
                    newRock_flat.position.z = 250 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -280 - j*400;
                    newRock_flat.position.z = 250 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/Rock3_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(270, 2, 250);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(10, 10, 10);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 270 + j*400;
                    newRock_smooth.position.z = 250 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -280 - j*400;
                    newRock_smooth.position.z = 250 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });                    
        
        loader.load( 'models/Door_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            door_flat = object;
            door_flat.position.set(-50, 10, 125);
            //door_flat.rotation.y = Math.PI;
            door_flat.scale.set(2.5, 2.5, 2.5);
            scene.add( door_flat );
            flat_models.push(door_flat);
        });
        
        loader.load( 'models/Door_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            door_smooth = object;
            door_smooth.position.set(-50, 10, 125);
            //door_smooth.rotation.y = Math.PI;
            door_smooth.visible = false;
            door_smooth.scale.set(2.5, 2.5, 2.5);
            scene.add( door_smooth );
            smooth_models.push(door_smooth);
        });
        
        loader.load( 'models/Chest_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            chest_flat = object;
            chest_flat.position.set(-760, 155, 1415);
            //door_flat.rotation.y = Math.PI;
            chest_flat.scale.set(5, 5, 5);
            scene.add( chest_flat );
            
        });
        
        loader.load( 'models/Chest_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            chest_smooth = object;
            chest_smooth.position.set(-760, 155, 1415);
            //door_smooth.rotation.y = Math.PI;
            chest_smooth.visible = false;
            chest_smooth.scale.set(5, 5, 5);
            scene.add( chest_smooth );
            
        });        
          
        loader.load( 'models/Bookcase_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(65, 2, 118);
            rock3_flat.rotation.y = Math.PI;
            rock3_flat.scale.set(8, 7, 7);
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
        });
        
        loader.load( 'models/Bookcase_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(65, 2, 118);
            rock3_smooth.rotation.y = Math.PI;
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(8, 7, 7);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
        });  
        
        loader.load( 'models/Bed_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(80, 4, -100);
            //door_flat.rotation.y = Math.PI;
            rock3_flat.scale.set(1.5, 1.5 ,1.5);
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
        });
        
        loader.load( 'models/Bed_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(80, 4, -100);
            //door_smooth.rotation.y = Math.PI;
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(1.5, 1.5 ,1.5);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
        });
        
        loader.load( 'models/Desk_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(-90, 0, -70);
            rock3_flat.rotation.y = Math.PI / 2;
            rock3_flat.scale.set(20, 20, 20);
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
        });
        
        loader.load( 'models/Desk_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(-90, 0, -70);
            rock3_smooth.rotation.y = Math.PI / 2;
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(20, 20, 20);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
        });        
        
        loader.load( 'models/Lamp_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            door_flat = object;
            door_flat.position.set(20, 0, 110);
            //door_flat.rotation.y = Math.PI;
            door_flat.scale.set(5, 5, 5);
            scene.add( door_flat );
            flat_models.push(door_flat);
            
            lever_flat = object.clone();
            lever_flat.position.set(40, 0, -115);
            //door_flat.rotation.y = Math.PI;
            lever_flat.scale.set(5, 5, 5);
            scene.add(lever_flat);
            flat_models.push(lever_flat);
        });
        
        loader.load( 'models/Lamp_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            door_smooth = object;
            door_smooth.position.set(20, 0, 110);
            //door_smooth.rotation.y = Math.PI;
            door_smooth.visible = false;
            door_smooth.scale.set(5, 5, 5);
            scene.add( door_smooth );
            smooth_models.push(door_smooth);
            
            
            lever_smooth = object.clone();
            lever_smooth.position.set(40, 0, -115);
            //door_smooth.rotation.y = Math.PI;
            lever_smooth.visible = false;
            lever_smooth.scale.set(5, 5, 5);
            scene.add( lever_smooth );
            smooth_models.push(lever_smooth);            
            
            
        });        
        
        loader.load( 'models/Rock3_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(270, 1, 250);
            rock3_flat.scale.set(10, 10, 10);
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 270 + j*400;
                    newRock_flat.position.z = 250 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -280 - j*400;
                    newRock_flat.position.z = 250 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/Rock3_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(270, 1, 250);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(10, 10, 10);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 270 + j*400;
                    newRock_smooth.position.z = 250 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -280 - j*400;
                    newRock_smooth.position.z = 250 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });         
        
        loader.load( 'models/WoodLog_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(230, 1, 230);
            rock3_flat.scale.set(2, 2, 2);
            
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -250 - j*400;
                    newRock_flat.position.z = 230 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 230 + j*400;
                    newRock_flat.position.z = 230 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/WoodLog_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(230, 1, 230);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(2, 2, 2);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -250 - j*400;
                    newRock_smooth.position.z = 230 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 230 + j*400;
                    newRock_smooth.position.z = 230 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });        

        loader.load( 'models/CommonTree_Dead_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(270, 1, 205);
            rock3_flat.scale.set(6.5, 6.5, 6.5);
            
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 270 + j*400;
                    newRock_flat.position.z = 205 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -300 - j*400;
                    newRock_flat.position.z = 200 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/CommonTree_Dead_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(270, 1, 205);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(6.5, 6.5, 6.5);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 270 + j*400;
                    newRock_smooth.position.z = 205 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -300 - j*400;
                    newRock_smooth.position.z = 200 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });                   

        loader.load( 'models/CommonTree_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(360, 1, 355);
            rock3_flat.scale.set(4, 4, 4);
            
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 360 + j*400;
                    newRock_flat.position.z = 355 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -375 - j*400;
                    newRock_flat.position.z = 350 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/CommonTree_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(360, 1, 355);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(4, 4, 4);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 360 + j*400;
                    newRock_smooth.position.z = 355 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -375 - j*400;
                    newRock_smooth.position.z = 350 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });      
        
        loader.load( 'models/CommonTree2_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(475, 1, 500);
            rock3_flat.scale.set(4, 4, 4);
            
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 475 + j*400;
                    newRock_flat.position.z = 500 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -500 - j*400;
                    newRock_flat.position.z = 500 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/CommonTree2_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(475, 1, 500);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(4, 4, 4);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 475 + j*400;
                    newRock_smooth.position.z = 500 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -500 - j*400;
                    newRock_smooth.position.z = 500 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });       
        
        loader.load( 'models/BushBerries_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(320, 1, 470);
            rock3_flat.scale.set(10, 10, 10);
            
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 320 + j*400;
                    newRock_flat.position.z = 470 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = -370 - j*400;
                    newRock_flat.position.z = 440 + i*300;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
            
        });
        
        loader.load( 'models/BushBerries_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(320, 1, 470);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(10, 10, 10);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 320 + j*400;
                    newRock_smooth.position.z = 470 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
            for(var i = 0; i<5; i++){
                for(var j = 0; j < 4; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = -370 - j*400;
                    newRock_smooth.position.z = 440 + i*300;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });
        
        loader.load( 'models/Lever_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(0, 90, 1050);
            rock3_flat.scale.set(10, 10, 10);
            
            scene.add( rock3_flat );
            normalLeverFlat = rock3_flat;
            
            //flat_models.push(rock3_flat);
                 
        });
        
        loader.load( 'models/Lever_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(0, 90, 1050);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(10, 10, 10);
            scene.add( rock3_smooth );
            normalLeverSmooth = rock3_smooth;
            
            //smooth_models.push(rock3_smooth);
            
        });         
        
        loader.load( 'models/Lever_used_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(0, 90, 1050);
            rock3_flat.visible = false;
            rock3_flat.scale.set(10, 10, 10);
            
            scene.add( rock3_flat );
            usedLeverFlat = rock3_flat;
            
            
            //flat_models.push(rock3_flat);
             
        });
        
        loader.load( 'models/Lever_used_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(0, 90, 1050);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(10, 10, 10);
            scene.add( rock3_smooth );
            usedLeverSmooth = rock3_smooth;
         
            //smooth_models.push(rock3_smooth);
            
        });  
        
        loader.load( 'models/Lever_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(-150, 190, 1450);
            rock3_flat.scale.set(10, 10, 10);
            scene.add( rock3_flat );
            normalLeverFlat2 = rock3_flat;
            
            //flat_models.push(rock3_flat);
                 
        });
        
        loader.load( 'models/Lever_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(-150, 190, 1450);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(10, 10, 10);
            scene.add( rock3_smooth );
            normalLeverSmooth2 = rock3_smooth;
            
            //smooth_models.push(rock3_smooth);
            
        });         
        
        loader.load( 'models/Lever_used_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(-150, 190, 1450);
            rock3_flat.visible = false;
            rock3_flat.scale.set(10, 10, 10);
            
            scene.add( rock3_flat );
            usedLeverFlat2 = rock3_flat;
            
             
        });
        
        loader.load( 'models/Lever_used_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(-150, 190, 1450);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(10, 10, 10);
            scene.add( rock3_smooth );
            usedLeverSmooth2 = rock3_smooth; 
            
            
            
            //smooth_models.push(rock3_smooth);
            
        });             

        loader.load( 'models/Cloud_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(1600, 1000, 200);
            rock3_flat.scale.set(20, 20, 20);
            
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<6; i++){
                for(var j = 0; j < 6; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 1600 - j*1300;
                    newRock_flat.position.y = 1000 + j%2 * 200;
                    newRock_flat.position.z = 200 + i*1100;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
                       
        });
        
        loader.load( 'models/Cloud_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(1600, 1000, 200);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(20, 20, 20);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<6; i++){
                for(var j = 0; j < 6; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 1600 - j*1300;
                    newRock_smooth.position.y = 1000 + j%2 * 200;
                    newRock_smooth.position.z = 200 + i*1100;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });
        
        loader.load( 'models/Cloud2_flat.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_flat = object;
            rock3_flat.position.set(1300, 1000, 300);
            rock3_flat.scale.set(50, 50, 50);
            
            scene.add( rock3_flat );
            flat_models.push(rock3_flat);
            
            for(var i = 0; i<6; i++){
                for(var j = 0; j < 6; j++){
                    var newRock_flat = rock3_flat.clone();
                    newRock_flat.position.x = 1300 - j*800;
                    newRock_flat.position.y = 1000 + j%2 * 200;
                    newRock_flat.position.z = 500 + i*1500;
                    
                    scene.add(newRock_flat);
                    flat_models.push(newRock_flat);                    
                }
            }
                       
        });      
        
        loader.load( 'models/Cloud2_smooth.glb', function ( gltf ) {

            var object = gltf.scene.children[0];
            rock3_smooth = object;
            rock3_smooth.position.set(1300, 1000, 300);
            rock3_smooth.visible = false;
            rock3_smooth.scale.set(50, 50, 50);
            scene.add( rock3_smooth );
            smooth_models.push(rock3_smooth);
            
            for(var i = 0; i<6; i++){
                for(var j = 0; j < 6; j++){
                    var newRock_smooth = rock3_smooth.clone();
                    newRock_smooth.position.x = 1300 - j*800;
                    newRock_smooth.position.y = 1000 + j%2 * 200;
                    newRock_smooth.position.z = 500 + i*1500;
                    
                    scene.add(newRock_smooth);
                    smooth_models.push(newRock_smooth);                    
                }
            }
            
        });
            
    
        
    }

    //Pointer Lock
    {
    function lockChangeAlert() {
        if (document.pointerLockElement === canvas ||
            document.mozPointerLockElement === canvas) {
            
            document.addEventListener("mousemove", updatePosition, false);
        }
        else {
        
        document.removeEventListener("mousemove", updatePosition, false);
        }
    }
    function updatePosition(e) {
      
        //var mouseX = e.movementX/500;
        //var mouseY = ((canvas.clientHeight - e.offsetY) / canvas.clientHeight)*2-1;    
    
        if(e.movementX/800 < 0.20 && e.movementX/800 > -0.20){
            
            camera.rotation.y -= e.movementX/800;
            camera.updateProjectionMatrix();
            if(isAnyObjectSelected){
                pickedobject.rotation.y-= e.movementX/800;
            }

        }
        if(e.movementY/800 < 0.20 && e.movementY/800 > -0.20){
            if(isSelectedBefore){
                camera.rotation.x -= e.movementY/800;
                camera.updateProjectionMatrix();
            }
            else{
                camera.rotation.x += e.movementY/800;
                camera.updateProjectionMatrix();
            }
            if(isAnyObjectSelected){
                pickedobject.rotation.x-= e.movementY/800;
                camera.updateProjectionMatrix();
            }

            
        }

        
    }
    }
    
    // Keyup - Keydown
    {
        function keyDown(event){
        if(event.keyCode == 80){    //"P" activates pointerlock
            if(!isLocked){
                isLocked = true;
                canvas.requestPointerLock();
                document.addEventListener('pointerlockchange', lockChangeAlert, false);
                document.addEventListener('mozpointerlockchange', lockChangeAlert, false);
                document.addEventListener('webkitpointerlockchange', lockChangeAlert, false);
            }
            else{
                isLocked = false;
                document.exitPointerLock();
                document.removeEventListener("mousemove", updatePosition, false);
            }  
        }
        else{
            keyboard[event.keyCode] = true;
        }
        
    }
        function keyUp(event){
        keyboard[event.keyCode] = false;
        if(event.keyCode == 16){
            player.speed = 1.6;
        }
    }     
    
        window.addEventListener("keydown", keyDown);
        window.addEventListener("keyup", keyUp);       
    }




    function resizeRendererToDisplaySize(renderer) {
        const canvas = renderer.domElement;
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        const needResize = canvas.width !== width || canvas.height !== height;
        if (needResize) {
            renderer.setSize(width, height, false);
        }
        return needResize;
    }
    
    class PickHelper {
    constructor() {
      this.raycaster = new THREE.Raycaster();
      this.pickedObject = null;
      this.pickedObjectSavedColor = 0;
    }
    pick(normalizedPosition, scene, camera, time) {
      // restore the color if there is a picked object
      /*if (this.pickedObject) {
        this.pickedObject.material.emissive.setHex(this.pickedObjectSavedColor);
        this.pickedObject = undefined;
      }*/

      // cast a ray through the frustum
      this.raycaster.setFromCamera(normalizedPosition, camera);
      
      //var planeZ = new THREE.Plane(new THREE.Vector3(0, 0, 1), 0);
      //var pos = raycaster.ray.intersectPlane(planeZ);
      
      
      // get the list of objects the ray intersected
      var intersectedObjects = this.raycaster.intersectObjects(movableModels, true);
      if (intersectedObjects.length && !isAnyObjectSelected) {
        // pick the first object. It's the closest one
        this.pickedObject = intersectedObjects[0].object;
        pickedobject = this.pickedObject;
        
        if(Math.abs(this.pickedObject.position.x - camera.position.x) <= 50 && Math.abs(this.pickedObject.position.y - camera.position.y) <= 50 && Math.abs(this.pickedObject.position.z - camera.position.z) <= 50){
            
            window.onkeydown = function( event ) {
                var key = event.keyCode;
                if(key == 69){  //E = Select object
                    if(isAnyObjectSelected == false){
                        
                        
                        isAnyObjectSelected = true; 
                        isSelectedBefore = true;
                    }
                }   
            };
                
      }
      
    }
  }
}
    
    const pickHelper = new PickHelper();
    clearPickPosition();
    
    var rotateAngle;

    window.addEventListener('keydown', function(e) {
  switch (e.keyCode) {
    case 68:
      input.right = 1;
      break;
    case 65:
      input.left = 1; 
      break;
    case 87:
      input.up = 1;
      break;
    case 83:
      input.down = 1;
      break;
  }
});
    window.addEventListener('keyup', function(e) {
  switch (e.keyCode) {
    case 68:
      input.right = 0;
      break;
    case 65:
      input.left = 0;
      break;
      case 87:
      input.up = 0;
      break;
    case 83:
      input.down = 0;
      break; 
  }
});

    function updateCannonWorld(){
        world.step(1/60);
        
        for(var i=0; i<boxes.length; i++){
            boxMeshes[i].position.copy(boxes[i].position);
            boxMeshes[i].quaternion.copy(boxes[i].quaternion);
        }


        
        
        if(movingPlatformBoxBody.position.x < -80){
            movingPlatformDirection = 1;
            movingPlatformBoxBody.position.x += 1.2;
        }
        else if(movingPlatformBoxBody.position.x > 80){
            movingPlatformDirection = 0;
            movingPlatformBoxBody.position.x -= 1.2;
        }
        else{
            if(movingPlatformDirection == 0) movingPlatformBoxBody.position.x -= 1.2;
            else movingPlatformBoxBody.position.x += 1.2;
        }
        if(Math.abs(camera.position.x - movingPlatformBoxBody.position.x) < 30 && Math.abs(camera.position.y - movingPlatformBoxBody.position.y) < 25 && Math.abs(camera.position.z - movingPlatformBoxBody.position.z) < 17){
            if(movingPlatformDirection == 0){
                camera.position.x -= 1.2;
                sphereBody.position.x -= 1.2;
            }
            else{
                camera.position.x += 1.2;
                sphereBody.position.x += 1.2;
            }
        }
        movingPlatformBoxMesh.position.copy(movingPlatformBoxBody.position);
        
        
        if(movingPlatformDirection2 == 1 && checkpointStatus == 2){
            if(movingPlatformBoxBody2.position.y <= 220){
                movingPlatformBoxBody2.position.y += 0.8;
                if(camera.position.x < 15 && camera.position.x > -15 && camera.position.z > 1280 && camera.position.z < 1315 && camera.position.y > 123){
                    camera.position.y += 0.8;
                    sphereBody.position.y += 0.8;
                }   
            }
            else{
                movingPlatformDirection2 = 0;
            }
        }
        if (movingPlatformDirection2 == 0 && checkpointStatus == 2){
            if(movingPlatformBoxBody2.position.y >= 80){
                movingPlatformBoxBody2.position.y -= 0.8;
                camera.position.y -= 0.8;
                sphereBody.position.y -= 0.8;                
            }
            else{
                movingPlatformDirection2 = 1;
            }
        }
        
        
        if(camera.position.x < 16 && camera.position.x > -16 && camera.position.z < 1246 && camera.position.z > 1214 && camera.position.y > 218 && camera.position.y < 222){    
            
            is1Falling = true;
        }
        else if(camera.position.x < 16 && camera.position.x > -16 && camera.position.z < 1326 && camera.position.z > 1294 && camera.position.y > 218 && camera.position.y < 222){   
           
            is2Falling = true;
        }
        else if(camera.position.x < -195 && camera.position.x > -225 && camera.position.z < 1465 && camera.position.z > 1435 && camera.position.y > 199 && camera.position.y < 202){
            
            is3Falling = true;
        }
        else if(camera.position.x < -275 && camera.position.x > -305 && camera.position.z < 1405 && camera.position.z > 1375 && camera.position.y > 199 && camera.position.y < 202){
            
            is4Falling = true;
        }        
        else if(camera.position.x < -355 && camera.position.x > -385 && camera.position.z < 1465 && camera.position.z > 1435 && camera.position.y > 199 && camera.position.y < 202){
            
            is5Falling = true;
        }
        else if(camera.position.x < -435 && camera.position.x > -465 && camera.position.z < 1405 && camera.position.z > 1375 && camera.position.y > 199 && camera.position.y < 202){
            
            is6Falling = true;
        }        
        else if(camera.position.x < -515 && camera.position.x > -545 && camera.position.z < 1465 && camera.position.z > 1435 && camera.position.y > 199 && camera.position.y < 202){
           
            is7Falling = true;
        }
        else if(camera.position.x < -595 && camera.position.x > -625 && camera.position.z < 1405 && camera.position.z > 1375 && camera.position.y > 199 && camera.position.y < 202){
            
            is8Falling = true;
        }
        else if(camera.position.x < -675 && camera.position.x > -705 && camera.position.z < 1435 && camera.position.z > 1405 && camera.position.y > 199 && camera.position.y < 202){
            
            is9Falling = true;
        }
      
        
        
        
        if(is1Falling == true){
            platformBoxBody3.mass = 1.0;
            platformBoxBody3.updateMassProperties();
            

        }
        if(is2Falling == true){
            platformBoxBody4.mass = 1.0;
            platformBoxBody4.updateMassProperties();            
        }
        
        
        if(is3Falling == true){
            platformBoxBody6.mass = 1.5;
            platformBoxBody6.updateMassProperties();   
        }
        if(is4Falling == true){
            platformBoxBody7.mass = 1.5;
            platformBoxBody7.updateMassProperties();            
        }
        if(is5Falling == true){
            platformBoxBody8.mass = 1.5;
            platformBoxBody8.updateMassProperties();
            

        }
        if(is6Falling == true){
            platformBoxBody9.mass = 1.5;
            platformBoxBody9.updateMassProperties();            
        }
        if(is7Falling == true){
            platformBoxBody10.mass = 1.5;
            platformBoxBody10.updateMassProperties();
            

        }
        if(is8Falling == true){
            platformBoxBody11.mass = 1.5;
            platformBoxBody11.updateMassProperties();            
        }
        if(is9Falling == true){
            platformBoxBody12.mass = 1.5;
            platformBoxBody12.updateMassProperties();
            

        }

        
    
    }
    

    function render(time) {
        time *= 0.001;  // convert to seconds
        
        requestAnimationFrame(render);


        updateCannonWorld();

        
        var delta = clock.getDelta();
        var moveDistance = 100 * delta;     // 200 pixels per second
        var rotateAngle = Math.PI / 2 * delta;      // pi/2 radians (90 degrees) per second
        
        //Checkpoints
        if(checkpointStatus == 0){
            checkpoint_x = 5;
            checkpoint_y = 20;
            checkpoint_z = -100;
        }
        else{
            scene.remove(discoCube);
        }
        
        if(checkpointStatus == 1 && !areLightsCreated){
            ambientLight = new THREE.AmbientLight(0xFFFFFF, 1.0);
            scene.add(ambientLight);
        
            var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
            scene.add( directionalLight );  
            areLightsCreated = true;
        }
        
        if (resizeRendererToDisplaySize(renderer)) {
            canvas = renderer.domElement;
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
        }
        
        
        if(isAnyObjectSelected){  

	// move forwards/backwards/left/right
	if ( keyboard[87] ){    //W
            if(pickedobject.rotation.x == 3.141592653589793 || pickedobject.rotation.x == -3.141592653589793 || pickedobject.rotation.x ==0){
                if(checkpointStatus == 0){
                    if(pickedobject.position.x > 95.0) pickedobject.position.x = 94.9;
                    if(pickedobject.position.x < -95.0) pickedobject.position.x = -94.9;
                    if(pickedobject.position.z > 120.0) pickedobject.position.z = 119.9;
                    if(pickedobject.position.z < -120.0) pickedobject.position.z = -119.9;
                }
                
                if((-95.0 > pickedobject.position.x || pickedobject.position.x < 95.0)  && (-120.0 > pickedobject.position.z || pickedobject.position.z < 120.0) && checkpointStatus == 0)  {
                pickedobject.translateZ( -moveDistance );
                } 
            }
        }
	if ( keyboard[83] ){    //S
            if(pickedobject.rotation.x == 3.141592653589793 || pickedobject.rotation.x == -3.141592653589793 || pickedobject.rotation.x ==0){
                                if(checkpointStatus == 0){
                    if(pickedobject.position.x > 95.0) pickedobject.position.x = 94.9;
                    if(pickedobject.position.x < -95.0) pickedobject.position.x = -94.9;
                    if(pickedobject.position.z > 120.0) pickedobject.position.z = 119.9;
                    if(pickedobject.position.z < -120.0) pickedobject.position.z = -119.9;
                }
                    if((-95.0 > pickedobject.position.x || pickedobject.position.x < 95.0)  && (-120.0 > pickedobject.position.z || pickedobject.position.z < 120.0) && checkpointStatus == 0)  {
                    pickedobject.translateZ( moveDistance );
                } 
            }       
        }
        
	// rotate left/right/up/down
	var rotation_matrix = new THREE.Matrix4().identity();
	if ( keyboard[65] ){ //A
            if(checkpointStatus == 0){
                    if(pickedobject.position.x > 95.0) pickedobject.position.x = 94.9;
                    if(pickedobject.position.x < -95.0) pickedobject.position.x = -94.9;
                    if(pickedobject.position.z > 120.0) pickedobject.position.z = 119.9;
                    if(pickedobject.position.z < -120.0) pickedobject.position.z = -119.9;
            }
            if((-95.0 > pickedobject.position.x || pickedobject.position.x < 95.0)  && (-120.0 > pickedobject.position.z || pickedobject.position.z < 120.0) && checkpointStatus == 0)
                pickedobject.rotateOnAxis( new THREE.Vector3(0,1,0), rotateAngle);

        }

	if ( keyboard[68] ){    //D
                if(checkpointStatus == 0){
                    if(pickedobject.position.x > 95.0) pickedobject.position.x = 94.9;
                    if(pickedobject.position.x < -95.0) pickedobject.position.x = -94.9;
                    if(pickedobject.position.z > 120.0) pickedobject.position.z = 119.9;
                    if(pickedobject.position.z < -120.0) pickedobject.position.z = -119.9;
                }
                if((-95.0 > pickedobject.position.x || pickedobject.position.x < 95.0)  && (-120.0 > pickedobject.position.z || pickedobject.position.z < 120.0) && checkpointStatus == 0)
                pickedobject.rotateOnAxis( new THREE.Vector3(0,1,0), -rotateAngle);
        } 


        /*if(keyboard[104]){   //8
            isRotationXChanged = true;
            pickedobject.rotateX(rotateAngle);
            //pickedobject.position.y += 1;
            
        }        
        if(keyboard[98]){   //2
            pickedobject.rotateOnAxis( new THREE.Vector3(1,0,0), -rotateAngle);
            isRotationXChanged = true;
        }   */    
        
        if(keyboard[100]){  //4
            pickedobject.rotateOnAxis( new THREE.Vector3(0,0,1), rotateAngle*3);
        }
        if(keyboard[102]){  //6
            pickedobject.rotateOnAxis( new THREE.Vector3(0,0,1), -rotateAngle*3);
        }
        if(keyboard[67]){   //C = return camera to normal position. Otherwise it doesn't move
            if(pickedobject.rotation.x < -1.57079632679){
                pickedobject.rotation.x = -3.141592653589793;
                pickedobject.rotation.z = -3.141592653589793;
            }
            else if(-1.57079632679 < pickedobject.rotation.x < 1.57079632679){
                pickedobject.rotation.x = 0;
                pickedobject.rotation.z = 0;
            }
            else{
                pickedobject.rotation.x = 3.141592653589793;
                pickedobject.rotation.z = 3.141592653589793;
            }
                
        }

	
	var relativeCameraOffset = new THREE.Vector3(0,player.height-10,30);

	var cameraOffset = relativeCameraOffset.applyMatrix4( pickedobject.matrixWorld );

	camera.position.x = cameraOffset.x;
	camera.position.y = cameraOffset.y;
	camera.position.z = cameraOffset.z;
        
        sphereBody.position.x = camera.position.x;
        //sphereBody.position.y = camera.position.y;
        sphereBody.position.z = camera.position.z;
        
        discoCubeLight.position.x = discoCube.position.x;
        discoCubeLight.position.y = discoCube.position.y;
        discoCubeLight.position.z = discoCube.position.z;
        
        
	camera.lookAt( pickedobject.position );
	
	camera.updateMatrix();
	camera.updateProjectionMatrix();
			
	
        }
    
        else{
            if(input.right == 1){
        //camera.rotation.y -= rotSpd;
                if(checkpointStatus == 0){
                    if(camera.position.x > 95.0) camera.position.x = 94.9;
                    if(camera.position.x < -95.0) camera.position.x = -94.9;
                    if(camera.position.z > 120.0) camera.position.z = 119.9;
                    if(camera.position.z < -120.0) camera.position.z = -119.9;
             
                if((-95.0 > camera.position.x || camera.position.x < 95.0)  && (-120.0 > camera.position.z || camera.position.z < 120.0) && checkpointStatus == 0)  {
                    if(isSelectedBefore){
                        camera.position.x += Math.sin(-camera.rotation.y + Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y + Math.PI/2) * player.speed;             
                   }
                    else{
                        camera.position.x += Math.sin(-camera.rotation.y - Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y - Math.PI/2) * player.speed; 
                    }

                    sphereBody.position.x = camera.position.x;
                    sphereBody.position.z = camera.position.z;
                   }
               }else{
                   if(camera.position.z < 180) camera.position.z = 180.1;
                                       if(isSelectedBefore){
                        camera.position.x += Math.sin(-camera.rotation.y + Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y + Math.PI/2) * player.speed;             
                   }
                    else{
                        camera.position.x += Math.sin(-camera.rotation.y - Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y - Math.PI/2) * player.speed; 
                    }

                    sphereBody.position.x = camera.position.x;
                    sphereBody.position.z = camera.position.z;
               }                    
            }  
            if(input.left == 1){
                //camera.rotation.y += rotSpd; 
                if(checkpointStatus == 0){
                    if(camera.position.x > 95.0) camera.position.x = 94.9;
                    if(camera.position.x < -95.0) camera.position.x = -94.9;
                    if(camera.position.z > 120.0) camera.position.z = 119.9;
                    if(camera.position.z < -120.0) camera.position.z = -119.9;
               
                if((-95.0 > camera.position.x || camera.position.x < 95.0)  && (-120.0 > camera.position.z || camera.position.z < 120.0) && checkpointStatus == 0)  {
                    if(isSelectedBefore){
                        camera.position.x += Math.sin(-camera.rotation.y - Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y - Math.PI/2) * player.speed; 
                    }
                    else{
                        camera.position.x += Math.sin(-camera.rotation.y + Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y + Math.PI/2) * player.speed;
                    }

                    sphereBody.position.x = camera.position.x;
                    sphereBody.position.z = camera.position.z;


                    /*if(pickedobject && isAnyObjectSelected){
                        pickedobject.position.x += rotSpd*3;
                        pickedobject.position.z += rotSpd*3;
                    }*/
                 }
                }
                else{
                    if(camera.position.z < 180) camera.position.z = 180.1;
                                        if(isSelectedBefore){
                        camera.position.x += Math.sin(-camera.rotation.y - Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y - Math.PI/2) * player.speed; 
                    }
                    else{
                        camera.position.x += Math.sin(-camera.rotation.y + Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(-camera.rotation.y + Math.PI/2) * player.speed;
                    }

                    sphereBody.position.x = camera.position.x;
                    sphereBody.position.z = camera.position.z;
                }
            }
            if(input.down == 1){
                if(checkpointStatus == 0){
                    if(camera.position.x > 95.0) camera.position.x = 94.9;
                    if(camera.position.x < -95.0) camera.position.x = -94.9;
                    if(camera.position.z > 120.0) camera.position.z = 119.9;
                    if(camera.position.z < -120.0) camera.position.z = -119.9;
                
                if((-95.0 > camera.position.x || camera.position.x < 95.0)  && (-120.0 > camera.position.z || camera.position.z < 120.0))  {
                    if(isSelectedBefore){
                        camera.position.z += Math.cos(camera.rotation.y) * player.speed;
                        camera.position.x += Math.sin(camera.rotation.y) * player.speed;
                        sphereBody.position.z = camera.position.z;
                        sphereBody.position.x = camera.position.x;
                    }
                    else{
                        camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
                        camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
                        sphereBody.position.z = camera.position.z;
                        sphereBody.position.x = camera.position.x;            
                    }
                }
               

                }
                else{
                    if(camera.position.z < 180) camera.position.z = 180.1;
                        if(isSelectedBefore){
                            camera.position.z += Math.cos(camera.rotation.y) * player.speed;
                            camera.position.x += Math.sin(camera.rotation.y) * player.speed;
                            sphereBody.position.z = camera.position.z;
                            sphereBody.position.x = camera.position.x;
                        }
                        else{
                            camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
                            camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
                            sphereBody.position.z = camera.position.z;
                            sphereBody.position.x = camera.position.x;            
                        }
                }
                
                
                
                
            }
            if(input.up == 1){
                if(checkpointStatus == 0){
                    if(camera.position.x > 95.0) camera.position.x = 94.9;
                    if(camera.position.x < -95.0) camera.position.x = -94.9;
                    if(camera.position.z > 120.0) camera.position.z = 119.9;
                    if(camera.position.z < -120.0) camera.position.z = -119.9;
                

                
                    if((-95.0 > camera.position.x || camera.position.x < 95.0)  && (-120.0 > camera.position.z || camera.position.z < 120.0))  {

                        if(isSelectedBefore){
                            camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
                            camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
                            sphereBody.position.z = camera.position.z;
                            sphereBody.position.x = camera.position.x;            
                        }
                        else{
                            camera.position.z += Math.cos(camera.rotation.y) * player.speed;
                            camera.position.x += Math.sin(camera.rotation.y) * player.speed;
                            sphereBody.position.z = camera.position.z;
                            sphereBody.position.x = camera.position.x;       
                        }
                    }           
                }
                else{
                    if(camera.position.z < 180) camera.position.z = 180.1;
                    
                        if(isSelectedBefore){
                            camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
                            camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
                            sphereBody.position.z = camera.position.z;
                            sphereBody.position.x = camera.position.x;            
                        }
                        else{
                            camera.position.z += Math.cos(camera.rotation.y) * player.speed;
                            camera.position.x += Math.sin(camera.rotation.y) * player.speed;
                            sphereBody.position.z = camera.position.z;
                            sphereBody.position.x = camera.position.x;       
                        }
                }
            
            
            
            }
  
            camera.position.y = sphereBody.position.y;
        } 



        window.onkeydown = function( event ) {
            var key = event.keyCode;
            if(key == 74){  //J = Change shading
                
                if(isFlat == true){
                    
                    
                    for(var i = 0; i < flat_models.length; i++){
                        flat_models[i].visible = false;
                        smooth_models[i].visible = true;
                    }
                    if(isLever1Used){
                        usedLeverSmooth.visible = true;
                        usedLeverFlat.visible = false;
                    }
                    else{
                        normalLeverSmooth.visible = true;
                        normalLeverFlat.visible = false;
                    }
                    if(isLever2Used){
                        usedLeverSmooth2.visible = true;
                        usedLeverFlat2.visible = false;
                    }
                    else{
                        normalLeverSmooth2.visible = true;
                        normalLeverFlat2.visible = false;
                    }                    
                    
                    if(!isChestTaken){
                        chest_flat.visible = false;
                        chest_smooth.visible = true;
                    }
                    
                    
                    isFlat = false;
                }
                else {
                   
                    for(var j = 0; j < flat_models.length; j++){
                        flat_models[j].visible = true;
                        smooth_models[j].visible = false;
                    }
                    if(isLever1Used){
                        usedLeverSmooth.visible = false;
                        usedLeverFlat.visible = true;
                    }
                    else{
                        normalLeverSmooth.visible = false;
                        normalLeverFlat.visible = true;
                    }
                    
                    if(isLever2Used){
                        usedLeverSmooth2.visible = false;
                        usedLeverFlat2.visible = true;
                    }
                    else{
                        normalLeverSmooth2.visible = false;
                        normalLeverFlat2.visible = true;
                    }                    
                    if(!isChestTaken){
                        chest_flat.visible = true;
                        chest_smooth.visible = false;
                    }
                    isFlat = true;
                }   
            }
            
            if(key == 16){  //LeftShift = Change player's speed(running)
                player.speed = 2.4;
            }
            
            if(key==69){ //E - Pick Object

                if(isAnyObjectSelected){
                    
                    camera.position.y = player.height;
                    sphereBody.position.y = camera.position.y;
                    isAnyObjectSelected = false;                      
                }
                
                
                if(!isAnyObjectSelected && (5 < camera.position.x && camera.position.x < 35) && (90 < camera.position.z && camera.position.z < 120)){
                    if(isLampOpened == true){
                        lampLight.intensity = 0.0;
                        lampLight2.intensity = 0.0;
                        isLampOpened = false;
                    }
                    else{
                        
                        lampLight.intensity = 0.8;
                        lampLight2.intensity = 0.8;
                        isLampOpened = true;                        
                    }
                }
                
                if(!isAnyObjectSelected && (25 < camera.position.x && camera.position.x < 55) && (-120 < camera.position.z && camera.position.z < -95)){
                    if(isLampOpened == true){
                        lampLight3.intensity = 0.0;
                        lampLight4.intensity = 0.0;
                        isLampOpened = false;
                    }
                    else{
                        
                        lampLight3.intensity = 0.8;
                        lampLight4.intensity = 0.8;
                        isLampOpened = true;                        
                    }
                }                
                
                //Checkpoint 1
                else if(!isAnyObjectSelected && (-63 < camera.position.x && camera.position.x < -35) && (95 < camera.position.z && camera.position.z < 125)){
                    camera.position.z = 200;
                    camera.position.x = -45;
                    
                    sphereBody.position.x = camera.position.x;
                    sphereBody.position.z = camera.position.z;
                    checkpointStatus = 1;
                    checkpoint_x = camera.position.x;
                    checkpoint_y = camera.position.y;
                    checkpoint_z = camera.position.z;
                    
                    //door_flat.position.z += 1;
                    door_flat.rotation.y = Math.PI * 2;
                    //door_smooth.position.z += 1;
                    door_smooth.rotation.y = Math.PI * 2;
                }
                //Checkpoint 2
                else if(!isAnyObjectSelected && (-40 < camera.position.x && camera.position.x < 40) && (1010 < camera.position.z && camera.position.z < 1090) && (108 < camera.position.y && camera.position.y < 111)){
                    checkpointStatus = 2;
                    checkpoint_x = 0;
                    checkpoint_y = 100;
                    checkpoint_z = 1050;
                    
                    movingPlatformDirection2 = 1;
                    
                    isLever1Used = true;
                    
                    if(isFlat){
                        normalLeverFlat.visible = false;
                        usedLeverFlat.visible = true;
                       
                    }
                    else if (!isFlat){
                        normalLeverSmooth.visible = false;
                        usedLeverSmooth.visible = true;
                      
                    }
                    
                }
                
                else if(!isAnyObjectSelected && (-110 > camera.position.x && camera.position.x > -190) && (1380 < camera.position.z && camera.position.z < 1550) && (208 < camera.position.y && camera.position.y < 211)){
                    checkpointStatus = 3;
                    checkpoint_x = -150;
                    checkpoint_y = 230;
                    checkpoint_z = 1450;
                    
                    isLever2Used = true;
                    
                    if(isFlat){
                        normalLeverFlat2.visible = false;
                        usedLeverFlat2.visible = true;
                    }
                    else if (!isFlat){
                        normalLeverSmooth2.visible = false;
                        usedLeverSmooth2.visible = true;
                    }
                    
                }                
                else if(!isAnyObjectSelected && (-735 > camera.position.x && camera.position.x > -760) && (1400 < camera.position.z && camera.position.z < 1430) && (173 < camera.position.y && camera.position.y < 176)){
                    chest_flat.visible = false;
                    chest_smooth.visible = false;
                    isChestTaken = true;
                    
                    
                }
                 
            }
             
            if(key == 90){  //Z = go to checkpoint
                camera.position.x = checkpoint_x;
                camera.position.y = checkpoint_y;
                camera.position.z = checkpoint_z;
                
                sphereBody.position.x = camera.position.x;
                sphereBody.position.y = camera.position.y;
                sphereBody.position.z = camera.position.z;
                
                
                if(checkpointStatus == 2){

                    
                    platformBoxBody3.position.set(0, 200, 1230);
                    platformBoxMesh3.position.set(0, 200, 1230);
                    
                    platformBoxBody4.position.set(0, 200, 1310);
                    platformBoxMesh4.position.set(0, 200, 1310);
                    
                    world.removeBody(platformBoxBody3);
                    world.removeBody(platformBoxBody4);
                    
                    scene.remove(platformBoxMesh3);
                    scene.remove(platformBoxMesh4);
                    
                    platformBoxBody3.position.set(0, 200, 1230);
                    platformBoxMesh3.position.set(0, 200, 1230);
                    

                    
                    world.add(platformBoxBody3);
                    scene.add(platformBoxMesh3);
                    platformBoxBody3.position.set(0, 200, 1230);
                    platformBoxMesh3.position.set(0, 200, 1230);

                    platformBoxMesh3.castShadow = true;
                    platformBoxMesh3.receiveShadow = true;
                    boxes.push(platformBoxBody3);
                    boxMeshes.push(platformBoxMesh3);
                    platformBoxBody3.mass = 0;
                    platformBoxBody3.updateMassProperties();
                    is1Falling = false;
                    
                    
                    platformBoxBody4.position.set(0, 200, 1310);
                    platformBoxMesh4.position.set(0, 200, 1310);
                    
                    world.add(platformBoxBody4);
                    scene.add(platformBoxMesh4);
                    platformBoxBody4.position.set(0, 200, 1310);
                    platformBoxMesh4.position.set(0, 200, 1310);

                    platformBoxMesh4.castShadow = true;
                    platformBoxMesh4.receiveShadow = true;
                    boxes.push(platformBoxBody4);
                    boxMeshes.push(platformBoxMesh4);   
                    platformBoxBody4.mass = 0;
                    platformBoxBody4.updateMassProperties();
                    is2Falling = false;
 

                }
                else if(checkpointStatus == 3){
                    
                    
                    world.removeBody(platformBoxBody6);
                    world.removeBody(platformBoxBody7);
                    world.removeBody(platformBoxBody8);
                    world.removeBody(platformBoxBody9);
                    world.removeBody(platformBoxBody10);
                    world.removeBody(platformBoxBody11);
                    world.removeBody(platformBoxBody12);
                    
                    
                    scene.remove(platformBoxBody6);
                    scene.remove(platformBoxBody7);
                    scene.remove(platformBoxBody8);
                    scene.remove(platformBoxBody9);
                    scene.remove(platformBoxBody10);
                    scene.remove(platformBoxBody11);
                    scene.remove(platformBoxBody12);
                      

                    is3Falling = false;
                    world.add(platformBoxBody6);
                    scene.add(platformBoxMesh6);
                    
                    platformBoxBody6.mass = 0;
                    platformBoxBody6.updateMassProperties();
                    
                    platformBoxBody6.position.set(-210, 180, 1450);
                    platformBoxMesh6.position.set(-210, 180, 1450);
                    
                    platformBoxMesh6.castShadow = true;
                    platformBoxMesh6.receiveShadow = true;
                    boxes.push(platformBoxBody6);
                    boxMeshes.push(platformBoxMesh6);
                    
                    
                    
                    
                    is4Falling = false;
                    world.add(platformBoxBody7);
                    scene.add(platformBoxMesh7);
                    platformBoxBody7.mass = 0;
                    platformBoxBody7.updateMassProperties();
                    
                    platformBoxBody7.position.set(-290, 180, 1390);
                    platformBoxMesh7.position.set(-290, 180, 1390);

                    platformBoxMesh7.castShadow = true;
                    platformBoxMesh7.receiveShadow = true;
                    boxes.push(platformBoxBody7);
                    boxMeshes.push(platformBoxMesh7);

                    
                    
                    is5Falling = false;
                    world.add(platformBoxBody8);
                    scene.add(platformBoxMesh8);
                    platformBoxBody8.mass = 0;
                    platformBoxBody8.updateMassProperties();
                    
                    platformBoxBody8.position.set(-370, 180, 1450);
                    platformBoxMesh8.position.set(-370, 180, 1450);

                    platformBoxMesh8.castShadow = true;
                    platformBoxMesh8.receiveShadow = true;
                    boxes.push(platformBoxBody8);
                    boxMeshes.push(platformBoxMesh8);
                    
                    
                    
                    is6Falling = false;
                    world.add(platformBoxBody9);
                    scene.add(platformBoxMesh9);
                    platformBoxBody9.mass = 0;
                    platformBoxBody9.updateMassProperties();
                    
                    platformBoxBody9.position.set(-450, 180, 1390);
                    platformBoxMesh9.position.set(-450, 180, 1390);

                    platformBoxMesh9.castShadow = true;
                    platformBoxMesh9.receiveShadow = true;
                    boxes.push(platformBoxBody9);
                    boxMeshes.push(platformBoxMesh9);
                    
                    
                    
                    is7Falling = false;
                    world.add(platformBoxBody10);
                    scene.add(platformBoxMesh10);
                    platformBoxBody10.mass = 0;
                    platformBoxBody10.updateMassProperties();
                    
                    platformBoxBody10.position.set(-530, 180, 1450);
                    platformBoxMesh10.position.set(-530, 180, 1450);

                    platformBoxMesh10.castShadow = true;
                    platformBoxMesh10.receiveShadow = true;
                    boxes.push(platformBoxBody10);
                    boxMeshes.push(platformBoxMesh10);
                    
                    
                    
                    is8Falling = false;
                    world.add(platformBoxBody11);
                    scene.add(platformBoxMesh11);
                    platformBoxBody11.mass = 0;
                    platformBoxBody11.updateMassProperties();
                    
                    platformBoxBody11.position.set(-610, 180, 1390);
                    platformBoxMesh11.position.set(-610, 180, 1390);

                    platformBoxMesh11.castShadow = true;
                    platformBoxMesh11.receiveShadow = true;
                    boxes.push(platformBoxBody11);
                    boxMeshes.push(platformBoxMesh11);
                    
                    
                    
                    is9Falling = false;
                    world.add(platformBoxBody12);
                    scene.add(platformBoxMesh12);
                    platformBoxBody12.position.set(0, 200, 1230);
                    platformBoxMesh12.position.set(0, 200, 1230);

                    platformBoxMesh12.castShadow = true;
                    platformBoxMesh12.receiveShadow = true;
                    boxes.push(platformBoxBody12);
                    boxMeshes.push(platformBoxMesh12);
                    platformBoxBody12.mass = 0;
                    platformBoxBody12.updateMassProperties();
                    
 
            
                }
                
                
            }    
            
            if(key == 32 && isAnyObjectSelected == false){  //Space = jump
                if (canJump === true) {
                    sphereBody.velocity.y = jumpVelocity;
                    
                }
                canJump = false;  
            }
            
            if(key == 107){
                if(checkpointStatus == 0){
                    discoCubeLight.intensity += 0.1;
                }
                else{
                    ambientLight.intensity += 0.1;
                }
            }
            if(key == 109){
                if(checkpointStatus == 0){
                    discoCubeLight.intensity -= 0.1;
                }
                else{
                    ambientLight.intensity -= 0.1;
                }
            }
            
            if(key == 77){
                
                if( THREEx.FullScreen.activated() ){
                    THREEx.FullScreen.cancel();
                }else{
                THREEx.FullScreen.request();
                }
            }

        };



        pickHelper.pick(pickPosition, scene, camera, time);

        
        discoCubeUniforms.iTime.value = time;
        
        renderer.render(scene, camera); 
    }

    requestAnimationFrame(render);
    
    function getCanvasRelativePosition(event) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: event.clientX - rect.left,
      y: event.clientY - rect.top,
    };
  }
    function setPickPosition(event) {
    const pos = getCanvasRelativePosition(event);
    pickPosition.x = (pos.x / canvas.clientWidth ) *  2 - 1;
    pickPosition.y = (pos.y / canvas.clientHeight) * -2 + 1;  // note we flip Y
  }
    function clearPickPosition() {
    // unlike the mouse which always has a position
    // if the user stops touching the screen we want
    // to stop picking. For now we just pick a value
    // unlikely to pick something
    pickPosition.x = -100000;
    pickPosition.y = -100000;
  }
  
    window.addEventListener('mousemove', setPickPosition);
    window.addEventListener('mouseout', clearPickPosition);
    window.addEventListener('mouseleave', clearPickPosition);
    
}   //end of main function

initCannon();
main();

</script>